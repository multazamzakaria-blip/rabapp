<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rekap Admin - Pengajuan RAB</title>
  <link rel="stylesheet" href="assets/style.css" />

  <!-- Tambahan Library untuk Export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body {
      font-family: "Poppins", sans-serif;
      background: #f8fafc;
    }

    .navbar {
      background: #0b63ce;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 22px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .navbar a {
      color: #fff;
      text-decoration: none;
      font-weight: 500;
    }

    .container {
      max-width: 1250px;
      margin: 40px auto;
      background: white;
      padding: 20px;
      border-radius: 14px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
      overflow-x: auto;
    }

    .summary-box {
      background: #e0f2fe;
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 18px;
      color: #0b63ce;
      font-weight: 600;
    }

    /* Filter bar */
    .filter-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
      align-items: center;
    }

    select, button.export-btn {
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
    }

    button.export-btn {
      cursor: pointer;
      background: #0b63ce;
      color: white;
      border: none;
    }

    button.export-btn:hover {
      background: #094fa3;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      background: #0b63ce;
      color: white;
      text-align: left;
      padding: 12px 10px;
      font-size: 15px;
      white-space: nowrap;
    }

    td {
      border-bottom: 1px solid #e5e7eb;
      padding: 10px;
      font-size: 14px;
      vertical-align: top;
    }

    tr:hover { background: #f9fbff; }

    .status {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 8px;
      color: white;
      font-size: 13px;
      text-align: center;
    }

    .status-menunggu { background: #f59e0b; }
    .status-ditolak { background: #ef4444; }
    .status-disetujui { background: #22c55e; }

    .btn-aksi {
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      color: white;
      font-size: 13px;
      cursor: pointer;
      transition: 0.2s;
    }

    .btn-aksi:hover { opacity: 0.85; }
  </style>
</head>

<body>
  <div class="navbar">
    <a href="dashboard.html">‚¨Ö Kembali</a>
    <h2>‚öôÔ∏è Rekap Admin - Pengajuan RAB</h2>
  </div>

  <div class="container">
    <div class="summary-box">
      Total Pengajuan Disetujui: <span id="totalAcc">Rp 0</span> |
      Menunggu: <span id="totalPending">Rp 0</span> |
      Ditolak: <span id="totalReject">Rp 0</span>
    </div>

    <!-- FILTER BAR -->
    <div class="filter-bar">
      <select id="filterBulan">
        <option value="">Filter Bulan</option>
        <option>Januari</option><option>Februari</option><option>Maret</option>
        <option>April</option><option>Mei</option><option>Juni</option>
        <option>Juli</option><option>Agustus</option><option>September</option>
        <option>Oktober</option><option>November</option><option>Desember</option>
      </select>

      <select id="filterDivisi">
        <option value="">Filter Divisi</option>
        <option>Direktur</option>
        <option>Pengasuhan Putra</option>
        <option>Pengasuhan Putri</option>
        <option>Pengajaran Putra</option>
        <option>Pengajaran Putri</option>
      </select>

      <select id="filterJenis">
        <option value="">Filter Jenis Program</option>
        <option>Program Peningkatan Mutu SDM</option>
        <option>Program Peningkatan Mutu Santri</option>
        <option>Pengadaan Barang</option>
        <option>Honorium SDM</option>
      </select>

      <button class="export-btn" id="btnExportPDF">üìÑ Export PDF</button>
      <button class="export-btn" id="btnExportExcel">üìä Export Excel</button>
    </div>

    <table id="rabAdminTable">
      <thead>
        <tr>
          <th>Nama Item</th>
          <th>Jenis</th>
          <th>Urgensi</th>
          <th>Bulan</th>
          <th>Harga Satuan</th>
          <th>Jumlah</th>
          <th>Total</th>
          <th>Divisi</th>
          <th>Status</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getDatabase, ref, get, update, remove } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA_kvyDshMXYNqj87bqXZC8tKAi_Kko2Rs",
      authDomain: "rabapp-520b5.firebaseapp.com",
      databaseURL: "https://rabapp-520b5-default-rtdb.firebaseio.com",
      projectId: "rabapp-520b5",
      storageBucket: "rabapp-520b5.firebasestorage.app",
      messagingSenderId: "1060443577862",
      appId: "1:1060443577862:web:6618775410d09ae16cad87",
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const tbody = document.querySelector("#rabAdminTable tbody");
    const totalAcc = document.getElementById("totalAcc");
    const totalPending = document.getElementById("totalPending");
    const totalReject = document.getElementById("totalReject");

    let allData = {};

    async function loadRABAdmin() {
      tbody.innerHTML = `<tr><td colspan="10" style="text-align:center;">‚è≥ Memuat data...</td></tr>`;
      const snapshot = await get(ref(db, "rabapp/pengajuan"));
      if (!snapshot.exists()) {
        tbody.innerHTML = `<tr><td colspan="10" style="text-align:center;">Belum ada data.</td></tr>`;
        return;
      }

      allData = snapshot.val();
      renderTable(Object.entries(allData));
    }

    function renderTable(entries) {
      tbody.innerHTML = "";
      let acc = 0, pending = 0, reject = 0;

      entries.forEach(([id, entry]) => {
        const bulanText = Array.isArray(entry.bulan)
          ? entry.bulan.join(", ")
          : entry.bulan || "-";
        const total = entry.total || 0;

        if (entry.status === "Disetujui") acc += total;
        else if (entry.status === "Menunggu") pending += total;
        else if (entry.status === "Ditolak") reject += total;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${entry.item}</td>
          <td>${entry.jenis}</td>
          <td>${entry.urgensi || "-"}</td>
          <td>${bulanText}</td>
          <td>Rp ${entry.harga?.toLocaleString("id-ID")}</td>
          <td>${entry.jumlah ?? "-"}</td>
          <td>Rp ${total.toLocaleString("id-ID")}</td>
          <td>${entry.division || "-"}</td>
          <td><span class="status ${
            entry.status === "Disetujui"
              ? "status-disetujui"
              : entry.status === "Ditolak"
              ? "status-ditolak"
              : "status-menunggu"
          }">${entry.status}</span></td>
          <td>
            <button class="btn-aksi" style="background:#22c55e;" onclick="updateStatus('${id}','Disetujui')">‚úî Setujui</button>
            <button class="btn-aksi" style="background:#ef4444;" onclick="updateStatus('${id}','Ditolak')">‚úñ Tolak</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      totalAcc.textContent = "Rp " + acc.toLocaleString("id-ID");
      totalPending.textContent = "Rp " + pending.toLocaleString("id-ID");
      totalReject.textContent = "Rp " + reject.toLocaleString("id-ID");
    }

    // ===== FILTER =====
    document.querySelectorAll("#filterBulan, #filterDivisi, #filterJenis").forEach(sel => {
      sel.addEventListener("change", () => {
        const bulan = document.getElementById("filterBulan").value;
        const divisi = document.getElementById("filterDivisi").value;
        const jenis = document.getElementById("filterJenis").value;

        const filtered = Object.entries(allData).filter(([_, entry]) => {
          const matchBulan = !bulan || (Array.isArray(entry.bulan) ? entry.bulan.includes(bulan) : entry.bulan === bulan);
          const matchDivisi = !divisi || entry.division === divisi;
          const matchJenis = !jenis || entry.jenis === jenis;
          return matchBulan && matchDivisi && matchJenis;
        });

        renderTable(filtered);
      });
    });

    // ===== EXPORT PDF =====
    document.getElementById("btnExportPDF").addEventListener("click", () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: "landscape" });
      doc.text("Laporan Rekap Pengajuan RAB", 14, 15);

      let rows = [["Nama Item","Jenis","Bulan","Harga","Jumlah","Total","Divisi","Status"]];
      Object.values(allData).forEach(e => {
        rows.push([
          e.item,
          e.jenis,
          Array.isArray(e.bulan)?e.bulan.join(", "):e.bulan,
          "Rp "+(e.harga||0).toLocaleString("id-ID"),
          e.jumlah,
          "Rp "+(e.total||0).toLocaleString("id-ID"),
          e.division||"-",
          e.status
        ]);
      });

      let y = 25;
      rows.forEach(r => {
        doc.text(r.join(" | "), 10, y);
        y += 8;
      });

      doc.save("rekap_pengajuan_RAB.pdf");
    });

    // ===== EXPORT EXCEL =====
    document.getElementById("btnExportExcel").addEventListener("click", () => {
      const wb = XLSX.utils.book_new();
      const wsData = [["Nama Item","Jenis","Bulan","Harga","Jumlah","Total","Divisi","Status"]];
      Object.values(allData).forEach(e => {
        wsData.push([
          e.item,
          e.jenis,
          Array.isArray(e.bulan)?e.bulan.join(", "):e.bulan,
          e.harga,
          e.jumlah,
          e.total,
          e.division||"-",
          e.status
        ]);
      });
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      XLSX.utils.book_append_sheet(wb, ws, "RAB");
      XLSX.writeFile(wb, "rekap_pengajuan_RAB.xlsx");
    });

    // ===== UPDATE STATUS =====
    window.updateStatus = async (id, status) => {
      await update(ref(db, "rabapp/pengajuan/" + id), { status });
      alert(`Status pengajuan diperbarui menjadi ${status}`);
      loadRABAdmin();
    };

    loadRABAdmin();
  </script>
</body>
</html>
